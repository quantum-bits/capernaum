\documentclass{article}

\usepackage[colorlinks]{hyperref}
\usepackage{booktabs}
\usepackage{graphicx}
\usepackage[svgnames]{xcolor}

\input{boxes}
\input{commands}

\title{\caper{} Architecture}
\author{Dr.\ Tom Nurkkala}

\begin{document}
\maketitle

\begin{abstract}
  It's \caper!
\end{abstract}

\tableofcontents

\section{Introduction}
\label{sec:introduction}

\caper{} is a web-based system
that gathers responses to designated surveys taken at {\qual}.
When notified of a completed survey by a \qual{} web hook,
\caper{}
downloads the survey response
to its \pg{} relational database
using the
\qual{} \href{https://api.qualtrics.com/}{\rest{} API}.
\caper{} then
analyzes the response and
prepares a personalized analysis for the respondent:
a \LaTeX-formatted PDF containing both a text commentary
and graphical visualizations of results.
Finally, \caper{}
emails the PDF to the survey respondent.
Figure~\ref{fig:features} highlights additional
key features of the \caper{} architecture.

\begin{figure}
  \centering
  \begin{featurebox}{Key Architectural Features}
    \begin{enumerate}
    \item Administrative and registration apps implemented using
      the \vue{} framework and
      the \vuetify{} UI toolkit.
    \item Server software uses
      the \node-based
      server-side framework \nest.
    \item Implemented entirely in \ts.
    \item \gql{} API
      federates access to both relational data and an external \rest{} API.
      Uses \apollo{} \gql.
    \item Push notification to administrative application using
      \gql{}
      \href{https://www.apollographql.com/docs/react/data/subscriptions/}{subscriptions}.
    \item Distributed job queuing system
      using \bull{}
      and \redis.
    \item Command line interface (\cli) for administration, fixture loading, and testing.
    \item Production performance monitoring using \prometheus.
      Reporting and visualization via \grafana.
    \item Data persistence uses the
      \typeorm{} object-relational mapper,
      backed by a 
      \pg{} relational database.
    \item Report generation using \href{https://www.latex-project.org/}{\LaTeX} for typesetting
      and \vega{} to render charts.
      Reports delivered to survey respondents using \nodemailer.
    \item Integrated with
      \qual{} survey platform
      using inbound web hooks and the \qual{}
      \href{https://api.qualtrics.com/}{\rest{} API},
      which is accessed using \axios.
    \item Fully open source on \href{https://github.com/quantum-bits/capernaum.git}{\gh}.
    \end{enumerate}
  \end{featurebox}
  \caption{Key features of the \caper{} architecture.}
  \label{fig:features}
\end{figure}

The main customer for \caper{}
is the
Center for Scripture Engagement
(\cfse)
at Taylor University (\tu).
As part of a faith-based institution,
the \cfse{} publishes the
Christian Life Survey
(\cls)
at \qual.
\caper{} provides automated analysis and reporting on survey results
for individual respondents and
can also aggregate responses for groups of users.
As of November, 2021,
\caper{} has processed just over 19,000 surveys.
Refer to Table~\ref{tab:caper-stats} for additional statistics about \caper.

\begin{table}
  \centering
  \begin{tabular}{lr}
    \toprule
    Initial Commit     & May, 2019      \\
    Production Release & December, 2019 \\
    \midrule
    Source files       & 356            \\
    Source lines       & 25,856         \\
    \midrule
    Reports processed  & 19,143         \\
    \bottomrule
  \end{tabular}
  \caption{\caper{} statistics (November, 2021).}
  \label{tab:caper-stats}
\end{table}

Traffic to the \cls{} is driven primarily by a partnership between \cfse{} and
\bg.
\bg{} is one of the top-three most-visited Christian web sites on the Internet.
In October, 2021, it was the
\href{https://www.similarweb.com/website/biblegateway.com/}{632-nd most visited site in the world,
  with 80~million visits}.
Although only a fraction of \bg{} users take the \cls,
the potential user volume is a key factor in the design of \caper.
In particular, \caper{} employs a distributed job queuing system
for survey analysis and report production,
designed to scale to handle 2,000 survey responses per minute.
This requirement is based on the \cfse{}'s
expectation that usage will grow significantly as \bg{}
begins actively promoting the \cls{} as planned.

\section{Architecture}
\label{sec:architecture}

Figure~\ref{fig:block-diagram}
presents a block diagram
of the \caper{} architecture.
\begin{figure}
  \centering
  \includegraphics[width=\textwidth]{block-diagram}
  \caption{Block diagram of \caper.
    Communication between distributed processes is indicated in the legend.}
  \label{fig:block-diagram}
\end{figure}

\ghsrc{Source Code Link}{
  Throughout this document,
  these boxes
  link to a relevant location
  in the \caper{} source code.
  Click anywhere on the box to view the code
  on \textsc{GitHub}.
}{README.md}{1}

\subsection{Servers}
\label{sec:servers}

\caper{} employs two server processes,
an \hyperref[sec:application-server]{application server},
which provides the majority of \caper{} administrative functionality,
and a \hyperref[sec:reporting-server]{reporting server},
which generates reports and emails them to survey respondents.

Both servers are built atop the \nest{} application framework for \node.
\nest{} integrates many best-of-breed services and packages
in a coherent and performant
\href{https://www.martinfowler.com/articles/injection.html}{dependency-injection}
framework.
\ghsrc{Dependency Injection}{
  Injecting a repository into a database service.
}{server/apps/server/src/survey/services/survey.service.ts}{19}

\subsubsection{Application Server}
\label{sec:application-server}

The application server is the main server-side component in \caper.

\caper{} leverages \nest{}
to support its
\gql{} API,
\typeorm{} object-relational mapping, and
\pg{} database access and schema migration.
Using \ts{}
\href{https://www.typescriptlang.org/docs/handbook/decorators.html}{decorators},
a single class
can be annotated to serve as both
an object-relational \emph{entity}
and a \gql{} \emph{type}.
This design eliminates redundant and misaligned class definitions.
\ghsrc{\gql{} and Object-Relational Mapping}{
  Example of a class with decorators
  creating both database entities
  and \gql{} \href{https://graphql.org/learn/schema/}{types}.
}{server/apps/server/src/survey/entities/survey.ts}{12}

The application and reporting servers
communicate via a \bull{} job queue
which uses \redis{} publish-subscribe
for inter-process communication.
The two-server design allows multiple reporting servers to be spun up
to handle increased demand as usage scales up.
\ghsrc{Queue a Bull Job}{The reporter process
  exposes a service
  injected by the application server
  to queue a reporting job
}{server/apps/reporter/src/queue/queue.service.ts}{14}

When a respondent completes a survey,
\qual{} triggers a web hook
to notify \caper{} that a new survey
is ready to be processed.
\caper{}
exposes a small number of \rest{} endpoints
accessed by \qual{} for this purpose.
\ghsrc{Process \qual{} Web Hook}{
  The \texttt{QualtricsController} class
  exposes endpoints to \qual.
  The \texttt{completedResponse} method
  handles the \qual{} hook triggered
  when a respondent completes a survey.
  This method uses the \texttt{reportService}
  (injected by the class constructor)
  to queue a new job for the reporting server via \bull.
}{server/apps/server/src/qualtrics/qualtrics.controller.ts}{14}

As the application server processes various events from \qual,
it stores those events in the database for later inspection.
The server also dynamically pushes events to the
\hyperref[sec:admin-app]{admin app}
using a \gql{} subscription.
Push notifications via the subscription mechanism
allow an administrative user
to monitor activity on the \caper{} server
in near-real-time.
\ghsrc{Push Notifications}{
  This method saves a server-side event in the database
  and pushes the event to the administration app
  via a \gql{} subscription
}{server/apps/server/src/events/event.service.ts}{21}

\caper{} exposes
a relevant subset of the \qual{} \rest{} API
to the rest of \caper.
\ghsrc{Consume \qual{} \rest{} API}{
  This dependency-injectable class
  gives access to all the \qual{} \rest{} endpoints
  needed by \caper.
}{server/libs/qualtrics-api/src/qualtrics-api.service.ts}{91}

The application server
uses the \texttt{QualtricsApiService}
for a variety of tasks, including these.
\begin{enumerate}
\item Retrieve surveys
\item Retrieve survey results
\item Establish and update \qual{} web hook endpoints
\end{enumerate}
\ghsrc{Import a Survey}{
  As an example of the use of the API service,
  this method
  import a \qual{} survey
  (including all questions and available responses)
  into \caper{} for use in report generation.
}{server/apps/server/src/qualtrics/qualtrics.service.ts}{34}

Although the majority of \caper{}'s API surface
is based on \gql{},
it also exposes a few traditional \rest{} endpoints
to simplify integration third-party modules
that don't support \gql.
For example, the \caper{}
\hyperref[sec:admin-app]{administration app}
uses
\href{https://www.npmjs.com/package/filepond}{filepond}
to support uploaded images for reports.
\ghsrc{Upload and Retrieve Files}{
  The injectable \texttt{ImageController}
  implements standard HTTP support for uploading and downloading images.
  The endpoints it exposes are used by
  the \hyperref[sec:admin-app]{administration app}
  when creating or updating report content.
}{server/apps/server/src/image/image.controller.ts}{L24}

\caper{} uses \jwt{} for access control.
Administrative users authenticate
with an email address and password (stored encrypted in the \caper{} database)
and are issued a JSON Web Token (\jwt)
that is used for authorization throughout a session.
\ghsrc{Authenticate a User}{
  The authentication service verifies a user at login time
  and issues a \jwt{} for session control.
  Note the use of injected services for the user and \jwt.
}{server/apps/server/src/auth/auth.service.ts}{14}

\subsubsection{Reporting Server}
\label{sec:reporting-server}

The reporting server
(or servers)
consumes requests posted by
the application server to the \bull{} job queue.

\ghsrc{Service the Bull Job Queue}{
  \nest{} provides the \texttt{Process} decorator
  to configure a method to respond to queued jobs.
}{server/apps/reporter/src/daemon/queue.daemon.ts}{14}

The reporting server
creates the report for an individual survey
and emails the report to the respondent.

\ghsrc{Create and send a report}{
  The reporting server
  exposes a service that's injected into the job queue handler
  to process a single survey response.
}{server/apps/reporter/src/report/report.service.ts}{43}

In addition to reports for \emph{individual} survey respondents, 
\caper{} supports summary reports
for \emph{groups} of respondents.
\caper{} generates an individual report
when \qual{} invokes the appropriate web hook
upon a single respondent completing a survey.
A group report, however,
is created at a specific time,
determined in advance when a group is registered with \caper.
To schedule group report generation,
\caper{} uses the \href{https://www.npmjs.com/package/cron}{\texttt{cron}} module,
which was inspired by the standard \unix{} \texttt{cron} mechanism.
\ghsrc{Schedule Group Reports}{
  This class configures the \texttt{cron} module to fire as configured,
  retrieve details for any group whose scheduled reporting time has passed,
  and triggers group report generation and delivery.
}{server/apps/reporter/src/daemon/cron.daemon.ts}{11}

Each time the \texttt{cron} timer expires, \caper{} generates group reports.

\ghsrc{Process a Group Report}{
  This method triggers group report generation.
}{server/apps/reporter/src/report/report.service.ts}{116}

Both individual and group reports are generated
using \LaTeX{} and \vega{}.

\caper uses \vega{} to create charts based on survey response data
and writes those files to disk.

\ghsrc{Create Graphs using \vega}{}{}{}

\caper{} writes \LaTeX{} sources
based on letter elements stored in the database
(created by the administrative user using the
\hyperref[sec:admin-app]{administrative application}).
The generated \LaTeX{} includes
directives to embed the charts previously created.

\ghsrc{Create \LaTeX{} Source}{}{}{}

Finally, the reporting server
runs \LaTeX{} itself to produce a high-quality PDF
that is then sent to the respondent by email.

\ghsrc{Compile \LaTeX{} Source into a PDF}{}{}{}

\ghsrc{Email a PDF Report to Respondent}{}{}{}

\subsection{Web Applications}
\label{sec:web-apps}

\subsubsection{Administrative Application}
\label{sec:admin-app}

\caper{} includes a \vue{}- and \vuetify{}-based
``single-page''
administrative web app.
The principal user of the admin app
is a person tasked with using \caper{}
to analyze and report on \qual{} surveys.
It allows such a user to:
\begin{enumerate}
\item Download the details of a survey from \qual{},
  either for the first time or to update \caper{} after a change is made to the survey on \qual.
\item Create or edit a report (``letter'') to be associated with a survey.
  The app provides a convenient drag-and-drop interface
  that allows the user to add, remove, and rearrange the various type of
  letter elements to be included in the report sent to survey respondents.
\item Upload and curate images to be used in report letters.
\item View searchable data about survey responses gathered from \qual.
\item Manually trigger the creation and delivery of a report for a survey respondent
  for purposes of debugging or verification.
\end{enumerate}


\subsubsection{Registration Application}
\label{sec:group-app}

\section{Data Model}
\label{sec:data-model-overview}

Figure~\ref{fig:summary-data-model}
shows an overview of the \caper{} data model.
A detailed model appears in Appendix~\ref{sec:detailed-data-model}.
\begin{figure}
  \centering
  \includegraphics[width=\textwidth]{data-model-overview}
  \caption{Summary data model for \caper.}
  \label{fig:summary-data-model}
\end{figure}
Related tables are grouped by color
and serve the following purposes.
\begin{description}
\item[\textcolor{Violet}{Surveys (violet)}]
  The \texttt{Survey} and \texttt{SurveyItem} tables
  capture the details of a single survey on \qual.
\item[\textcolor{Salmon}{Survey Responses (salmon)}]
  The \texttt{SurveyResponse}
  and \texttt{SurveyItemResponse}
  tables store the responses a single respondent
  makes to a survey.
\item[\textcolor{LightBlue}{Letters (light blue)}]
  Reports sent to survey respondents are called ``letters'' in the data model.
  Report content is entirely data driven and can be updated by a \caper's administrative user
  as desired for new surveys, new versions of a survey, or new report formats.
\item[\textcolor{Goldenrod}{Groups (gold)}]
  Survey respondents be members of a group of respondents
\item[\textcolor{LightGreen}{Users (green)}]
  Only administrative users need to log into \caper{} itself.
  It implements simple role-based security.
\end{description}

\section{Command-Line Interface}
\label{sec:cli}

\section{Dev Ops}
\label{sec:deployment}

\caper{} employs a fully-automated deployment
using \ansible.
The provisioning file contains commands for \gh{}, OS updates, etc.
\ghsrc{Ansible Provisioning}{
  Ansible provisioning for full \caper{} deployment to Linux.
}{ansible/provision.yaml}{1}

\appendix

\section{Detailed Data Model}
\label{sec:detailed-data-model}

Figure~\ref{fig:erd} shows the entity-relationship diagram for \caper's \pg{} database.
\begin{figure}
  \centering
  \includegraphics[width=\textwidth]{data-model}
  \caption{Entity-relationship diagram for \caper.}
  \label{fig:erd}
\end{figure}

\paragraph{\textcolor{Violet}{Surveys (violet)}}

The \texttt{Survey} and \texttt{SurveyItem} tables
capture the details of a single survey on \qual.
Using identifiers provided by \qual,
these tables allow \caper{} to perform the statistical analysis at the heart of each report letter.
To support statistical analysis,
\caper{} allows survey questions to be grouped into a category hierarchy.
Each survey question (\texttt{SurveyItem})
can be grouped into a \texttt{SurveyIndex},
which can in turn be grouped into a \texttt{SurveyDimension}.
\caper{} uses the latter entity to calculate aggregate attitudes
toward characteristics measured by the survey instrument itself.

\paragraph{\textcolor{Salmon}{Survey Responses (salmon)}}

The \texttt{SurveyResponse}
and \texttt{SurveyItemResponse}
tables store the responses a single respondent
makes to a survey.
\texttt{SurveyResponse} is related to a survey
and has one associated \texttt{SurveyItemResponse}
for each \texttt{SurveyItem}.

\paragraph{\textcolor{LightBlue}{Letters (light blue)}}

Reports sent to survey respondents are called ``letters'' in the data model.
Report content is entirely data driven and can be updated by a \caper's administrative user
as desired for new surveys, new versions of a survey, or new report formats.

Each \texttt{Letter} contains multiple
instances of a \texttt{LetterElement}.
A \texttt{LetterElement} has an associated type
(e.g., boilerplate text,
uploaded image,
graph of analytical results).

\caper{} can report results for individual survey respondents
and can also aggregate results for people who identify as part of a group.
The \texttt{LetterType} entity enforce this distinction
and also partitions the types of letter elements,
allowing the user interface to present only valid \emph{element} types
for each \emph{letter} type.

\paragraph{\textcolor{Goldenrod}{Groups (gold)}}

Survey respondents can indicate membership in a group of respondents
(e.g., members of a church, students in a course).
Each \texttt{Group} entity stores the detail of one group
and will be associated with a \texttt{SurveyResponse}
when the respondent enters his or her group code
prior to taking the survey.

\paragraph{\textcolor{LightGreen}{Users (green)}}

Because only a few administrative users have a need to log into \caper{} itself,
its user management is quite modest.
There is a many-to-many relationship between \texttt{User} and \texttt{User Role},
allowing for conventional role-based access control.

A \texttt{User} authenticates with an email address and password.
Passwords are stored in encrypted form in the database.
One a user logs in,
access is granted using a
JSON Web Token (\jwt)
that enumerates each \texttt{UserRole} for which the \texttt{User} is authorized.

\texttt{UserRole} data are employed to control access to views
in the administrative application in the browser
as well as \gql{} and \rest{} API access on the server.


\end{document}

%%% Local Variables:
%%% mode: latex
%%% TeX-master: t
%%% End:

% LocalWords:  Ansible Qualtrics nd lr SurveyItem SurveyIndex UserRole README
% LocalWords:  SurveyDimension SurveyResponse SurveyItemResponse LightBlue md
% LocalWords:  LetterElement LetterType LightGreen QualtricsController Dev
% LocalWords:  completedResponse reportService filepond ImageController
